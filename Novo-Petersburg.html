<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Тени на Невском</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=EB+Garamond:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-database-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>
  <style>
    :root {
      --primary: #D4A017; /* Muted gold for elegance */
      --secondary: #1E2A44; /* Deep blue for the Neva's mystique */
      --accent: #B0B7C6; /* Silver for subtle highlights */
      --background: #2B2B2B; /* Dark gray for moody atmosphere */
      --surface: #3C3C3C; /* Slightly lighter gray for cards */
      --surface-light: #4A4A4A; /* Light gray for inputs */
      --text: #E8E8E8; /* Off-white for readability */
      --text-muted: #A0A0A0; /* Muted gray for secondary text */
      --glow: 0 0 15px rgba(212, 160, 23, 0.4); /* Subtle gold glow */
      --shadow-sm: 0 4px 10px rgba(0, 0, 0, 0.5);
      --shadow-md: 0 8px 20px rgba(0, 0, 0, 0.6);
      --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.7);
      --border-radius: 8px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
    }

    body.light-theme {
      --background: #F5F5F5; /* Parchment-like background */
      --surface: #FFFFFF; /* White for cards */
      --surface-light: #F0F0F0; /* Light gray for inputs */
      --text: #2B2B2B; /* Dark gray for text */
      --text-muted: #5A5A5A; /* Muted gray for secondary text */
      --glow: 0 0 10px rgba(212, 160, 23, 0.3);
      --shadow-sm: 0 4px 10px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 8px 20px rgba(0, 0, 0, 0.15);
      --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.2);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'EB Garamond', serif;
      background-color: var(--background);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.8;
      position: relative;
      transition: background-color 0.4s ease, color 0.4s ease;
    }

    #fog-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(rgba(43, 43, 43, 0.9), rgba(43, 43, 43, 0.9)),
                  url('https://via.placeholder.com/1920x1080/2B2B2B/D4A017?text=Cobblestone+Fog') no-repeat center center/cover;
      z-index: -2;
      opacity: 0.4;
      animation: fog 10s infinite ease-in-out;
    }

    @keyframes fog {
      0%, 100% { transform: translateY(0); opacity: 0.4; }
      50% { transform: translateY(-20px); opacity: 0.5; }
    }

    header {
      background: linear-gradient(to right, rgba(30, 42, 68, 0.95), rgba(43, 43, 43, 0.85));
      backdrop-filter: blur(10px);
      padding: var(--spacing-md) var(--spacing-xl);
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-sm), var(--glow);
      border-bottom: 2px solid var(--primary);
    }

    body.light-theme header {
      background: linear-gradient(to right, rgba(245, 245, 245, 0.95), rgba(240, 240, 240, 0.85));
      box-shadow: var(--shadow-sm);
    }

    .logo-container {
      display: flex;
      align-items: center;
    }

    .logo {
      font-family: 'Cinzel', serif;
      font-weight: 700;
      font-size: 2rem;
      letter-spacing: 2px;
      color: var(--text);
      text-decoration: none;
      position: relative;
      text-transform: uppercase;
      transition: color 0.3s ease;
    }

    .logo:hover {
      color: var(--primary);
      text-shadow: var(--glow);
    }

    .logo::before {
      content: '';
      position: absolute;
      left: -10px;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 80%;
      background: var(--primary);
      border-radius: 2px;
    }

    .nav-actions {
      display: flex;
      gap: var(--spacing-md);
      align-items: center;
    }

    .nav-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-family: 'EB Garamond', serif;
      font-size: 1rem;
      padding: var(--spacing-sm) var(--spacing-md);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      text-transform: uppercase;
    }

    .nav-btn:hover {
      color: var(--primary);
      text-shadow: var(--glow);
    }

    .nav-btn::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 1px;
      background: var(--primary);
      transition: width 0.3s ease;
    }

    .nav-btn:hover::after {
      width: 70%;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--spacing-xl);
      display: none;
      opacity: 0;
      transition: opacity 0.7s ease-in-out;
      position: relative;
    }

    .container.visible {
      display: block;
      opacity: 1;
    }

    .book-cover-section {
      position: relative;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      background: var(--background);
      overflow-y: auto;
      padding: var(--spacing-xl) var(--spacing-md);
    }

    .book-cover-wrapper {
      perspective: 800px;
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
    }

    .book-cover-section img {
      max-width: 400px;
      max-height: 600px;
      width: 100%;
      height: auto;
      object-fit: contain;
      border-radius: 10px;
      box-shadow: var(--shadow-lg), var(--glow);
      border: 2px solid var(--primary);
      transition: transform 0.5s ease, box-shadow 0.5s ease;
    }

    .book-cover-section img:hover {
      transform: rotateY(5deg) translateZ(50px);
      box-shadow: var(--shadow-lg), 0 0 25px rgba(212, 160, 23, 0.6);
    }

    .book-cover-section p {
      color: var(--text-muted);
      font-size: 1.3rem;
      max-width: 600px;
      margin-bottom: var(--spacing-lg);
      font-family: 'EB Garamond', serif;
      text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
      animation: fadeInText 2s ease-in-out;
    }

    @keyframes fadeInText {
      0% { opacity: 0; transform: translateY(15px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .explore-btn {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--text);
      border: none;
      padding: var(--spacing-md) var(--spacing-xl);
      border-radius: 6px;
      font-family: 'Cinzel', serif;
      font-weight: 600;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      transition: all 0.4s ease;
      box-shadow: var(--shadow-md), var(--glow);
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
    }

    .explore-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(212, 160, 23, 0.3), transparent);
      transition: left 0.5s ease;
    }

    .explore-btn:hover::before {
      left: 100%;
    }

    .explore-btn:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg), 0 0 30px rgba(212, 160, 23, 0.7);
    }

    .explore-btn i {
      font-size: 1.2rem;
    }

    .action-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--spacing-lg);
      align-items: center;
      background: rgba(30, 42, 68, 0.5);
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
    }

    .status-indicator {
      display: flex;
      align-items: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      font-family: 'EB Garamond', serif;
    }

    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: var(--spacing-sm);
    }

    .status-dot.online {
      background: var(--accent);
    }

    .status-dot.offline {
      background: #A01717; /* Dark red for errors */
    }

    .status-dot.syncing {
      background: #D4A017;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.5; }
    }

    .toggle-form-btn, .language-toggle-btn {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--text);
      border: none;
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: 6px;
      font-family: 'Cinzel', serif;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      transition: all 0.4s ease;
      box-shadow: var(--shadow-sm);
      text-transform: uppercase;
    }

    .toggle-form-btn:hover, .language-toggle-btn:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md), var(--glow);
    }

    .chapter-form, .gallery-form {
      background: var(--surface);
      padding: var(--spacing-xl);
      border-radius: var(--border-radius);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-lg), var(--glow);
      border: 1px solid var(--primary);
      display: none;
      animation: slideDown 0.6s ease-out;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
    }

    .form-header h2 {
      font-family: 'Cinzel', serif;
      font-weight: 700;
      font-size: 1.7rem;
      color: var(--text);
      text-shadow: 0 0 8px rgba(212, 160, 23, 0.3);
    }

    .form-group {
      margin-bottom: var(--spacing-lg);
    }

    .form-group label {
      display: block;
      margin-bottom: var(--spacing-sm);
      color: var(--text-muted);
      font-size: 1rem;
      font-family: 'EB Garamond', serif;
    }

    .chapter-form input[type="text"],
    .chapter-form textarea,
    .gallery-form input[type="text"],
    .gallery-form input[type="url"] {
      width: 100%;
      padding: var(--spacing-md);
      background: var(--surface-light);
      border: 1px solid var(--primary);
      color: var(--text);
      font-family: 'EB Garamond', serif;
      border-radius: 4px;
      font-size: 1.1rem;
      transition: all 0.4s ease;
    }

    .chapter-form input:focus,
    .chapter-form textarea:focus,
    .gallery-form input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(176, 183, 198, 0.3);
    }

    .chapter-form textarea {
      min-height: 300px;
      resize: vertical;
    }

    .character-input-group {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      align-items: center;
    }

    .character-input-group input {
      flex: 1;
    }

    .character-input-group .remove-character-btn {
      background: transparent;
      border: 1px solid #A01717;
      color: #A01717;
      padding: var(--spacing-sm);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
    }

    .character-input-group .remove-character-btn:hover {
      background: rgba(160, 23, 23, 0.2);
      color: var(--accent);
    }

    .add-character-btn {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--text);
      border: none;
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: 6px;
      font-family: 'Cinzel', serif;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-sm);
      transition: all 0.4s ease;
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--spacing-lg);
    }

    .add-character-btn:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md), var(--glow);
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: var(--spacing-md);
    }

    .btn {
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: 6px;
      font-family: 'Cinzel', serif;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.4s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--text);
      border: none;
      box-shadow: var(--shadow-sm), var(--glow);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md), 0 0 20px rgba(212, 160, 23, 0.6);
    }

    .btn-secondary {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--primary);
    }

    .btn-secondary:hover {
      background: rgba(212, 160, 23, 0.1);
      color: var(--text);
    }

    .chapter-grid, .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: var(--spacing-lg);
    }

    .chapter-card, .location-card {
      background: var(--surface);
      border-radius: var(--border-radius);
      overflow: hidden;
      transition: all 0.5s ease;
      cursor: pointer;
      position: relative;
      box-shadow: var(--shadow-md), var(--glow);
      border: 1px solid var(--primary);
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .chapter-card:hover, .location-card:hover {
      transform: translateY(-8px);
      box-shadow: var(--shadow-lg), 0 0 30px rgba(212, 160, 23, 0.5);
      border-color: var(--accent);
    }

    .chapter-card::before, .location-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--primary);
    }

    .card-content {
      padding: var(--spacing-lg);
      flex-grow: 1;
    }

    .chapter-card h3, .location-title {
      color: var(--text);
      margin-bottom: var(--spacing-md);
      font-size: 1.4rem;
      font-weight: 600;
      font-family: 'Cinzel', serif;
      text-shadow: 0 0 4px rgba(212, 160, 23, 0.2);
    }

    .chapter-card p {
      color: var(--text-muted);
      font-size: 1rem;
      font-family: 'EB Garamond', serif;
    }

    .card-footer {
      padding: var(--spacing-md) var(--spacing-lg);
      background: rgba(0, 0, 0, 0.2);
      display: flex;
      justify-content: flex-end;
      gap: var(--spacing-sm);
      border-top: 1px solid var(--primary);
    }

    .card-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: var(--spacing-sm);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .card-btn:hover {
      background: rgba(212, 160, 23, 0.2);
      color: var(--accent);
    }

    .card-btn i {
      font-size: 1.1rem;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
    }

    body.light-theme .modal {
      background: rgba(245, 245, 245, 0.9);
    }

    .modal-content {
      background: var(--surface);
      border-radius: var(--border-radius);
      max-width: 900px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      position: relative;
      animation: fadeIn 0.5s ease;
      box-shadow: var(--shadow-lg), var(--glow);
      border: 1px solid var(--primary);
    }

    .modal#galleryModal .modal-content {
      max-width: 85vw;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .modal#galleryModal .modal-body {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: var(--spacing-md);
    }

    .modal#galleryModal img {
      max-width: 100%;
      max-height: 75vh;
      object-fit: contain;
      border: 1px solid var(--primary);
      box-shadow: var(--shadow-lg), var(--glow);
      transition: transform 0.3s ease;
    }

    .modal#galleryModal img:hover {
      transform: scale(1.03);
    }

    .modal-header {
      padding: var(--spacing-lg) var(--spacing-xl);
      border-bottom: 1px solid var(--primary);
      position: sticky;
      top: 0;
      background: var(--surface);
      z-index: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-family: 'Cinzel', serif;
      font-weight: 700;
      font-size: 1.7rem;
      color: var(--text);
      text-shadow: 0 0 8px rgba(212, 160, 23, 0.3);
    }

    .modal-body {
      padding: var(--spacing-xl);
    }

    .modal-body p {
      line-height: 1.9;
      color: var(--text);
      white-space: pre-wrap;
      font-size: 1.1rem;
      font-family: 'EB Garamond', serif;
    }

    .close-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 1.6rem;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .close-btn:hover {
      background: rgba(212, 160, 23, 0.2);
      color: var(--accent);
    }

    .empty-state {
      text-align: center;
      padding: var(--spacing-xl) 0;
      color: var(--text-muted);
    }

    .empty-state i {
      font-size: 3.5rem;
      margin-bottom: var(--spacing-lg);
      opacity: 0.6;
      text-shadow: var(--glow);
    }

    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: var(--spacing-md);
      color: var(--text);
      font-family: 'Cinzel', serif;
    }

    .empty-state p {
      max-width: 500px;
      margin: 0 auto;
      font-family: 'EB Garamond', serif;
    }

    .theme-toggle {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .theme-toggle:hover {
      background: rgba(212, 160, 23, 0.2);
      color: var(--accent);
    }

    .loader {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 3000;
      justify-content: center;
      align-items: center;
    }

    body.light-theme .loader {
      background: rgba(245, 245, 245, 0.8);
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(212, 160, 23, 0.3);
      border-radius: 50%;
      border-top: 5px solid var(--primary);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: var(--surface);
      color: var(--text);
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: 8px;
      box-shadow: var(--shadow-lg), var(--glow);
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      z-index: 2500;
      opacity: 0;
      transform: translateY(30px);
      transition: all 0.5s ease;
      max-width: 350px;
      border: 1px solid var(--primary);
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast-icon {
      font-size: 1.3rem;
    }

    .toast.success .toast-icon {
      color: var(--accent);
    }

    .toast.error .toast-icon {
      color: #A01717;
    }

    .toast.warning .toast-icon {
      color: #D4a017;
    }

    .gallery-section {
      padding: var(--spacing-xl);
      background: var(--background);
    }

    .location-card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      display: block;
      cursor: pointer;
    }

    .location-title {
      padding: var(--spacing-md);
      text-align: center;
      font-family: 'Cinzel', serif;
      font-size: 1.2rem;
      color: var(--text);
      text-shadow: 0 0 4px rgba(212, 160, 23, 0.2);
    }

    .character-grid {
      display: none;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: rgba(0, 0,0.2);
      border-top: 1px solid var(--primary);
    }

    .character-grid.active {
      display: grid;
    }

    .character-card {
      background: var(--surface-light);
      border-radius: 6px;
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .character-card:hover {
      transform: scale(1.03);
      box-shadow: var(--shadow-md), 0 0 15px rgba(212, 160, 23, 0.3);
    }

    .character-card img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      cursor: pointer;
    }

    .character-name {
      padding: var(--spacing-sm);
      text-align: center;
      font-family: 'EB Garamond', serif;
      font-size: 1rem;
      color: var(--text);
    }

    .login-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0.9);
      backdrop-filter: blur(10px);
      z-index: 2500;
      align-items: center;
      justify-content: center;
    }

    body.light-theme .login-modal {
      background: rgba(245, 245,245, 0.9);
    }

    .login-modal-content {
      background: var(--surface);
      border-radius: var(--border-radius));
      max-width: 450px;
      width: 90%;
      padding: var(--spacing-xl);
      box-shadow: var(--shadow-lg), var(--shadow-md), var(--glow));
      border: 1px solid var(--primary);
    }

    .login-modal-content h2 {
      font-family: 'Cinzel', serif;
      font-weight: 700;
      font-size: 1.7rem;
      color: var(--text);
      text-shadow: 0 0 8px rgba(212, 160, 23, 0.3);
      margin-bottom: var(--spacing-lg);
    }

    .login-form-group {
      margin-bottom: var(--spacing-lg);
    }

    .login-form-group input {
      width: 100%;
      padding: var(--spacing-md);
      background: var(--surface-light);
      border: 1px solid var(--primary);
      color: var(--text);
      font-family: 'EB Garamond', serif;
      border-radius: 4px;
      font-size: 1.1rem;
      transition: all 0.4s ease;
    }

    .login-form-group input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(176, 183, 198, 0.3);
    }

    .hidden-btn {
      display: none !important;
    }

    @media (max-width: 768px) {
      .book-cover-section {
        padding: var(--spacing-lg) var(--spacing-sm);
      }

      .book-cover-section img {
        max-width: 300px;
        max-height: 450px;
      }

      .book-cover-section p {
        font-size: 1.1rem;
        padding: 0 var(--spacing-sm);
      }

      .explore-btn {
        font-size: 1.1rem;
        padding: var(--spacing-sm) var(--spacing-lg);
      }

      .logo {
        font-size: 1.7rem;
      }

      .nav-btn {
        font-size: 0.9rem;
        padding: var(--spacing-sm);
      }

      .gallery-grid {
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      }

      .location-card {
        height: 140px;
      }

      .character-grid {
        grid-template-columns: repeat(auto-fill, minmax(176px, 1fr));
      }
    }

    @media (max-width: 480px) {
      .book-cover-section img {
        max-width: 250px;
        max-height: 400px;
      }

      .book-cover-section p {
        font-size: 1rem;
      }

      .explore-btn {
        font-size: 1rem;
        padding: var(--spacing-sm) var(--spacing-md);
      }

      .gallery-grid {
        grid-template-columns: 1fr;
      }

      .location-card {
        height: 100px;
      }

      .character-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px));
      }

      .character-card img {
        max-height: -width:90px;
      }
    }
  </style>
</head>
<body>
  <div id="fog-bg"></div>
  <div class="loader" id="loader">
    <div class="spinner"></div>
  </div>
  <header class>
    <div class="logo-container">
      <a href="#" class="logo">Тени на Невском</a>
    </div>
    <div class="nav-actions">
      <button class="nav-btn" id="exploreGalleryBtn">Галерея</button>
      <button class="nav-btn" id="exploreChaptersBtn">Главы</button>
      <button class="nav-btn admin-only" id="toggleChapterFormBtn">Новая глава</button>
      <button class="nav-btn admin-only" id="toggleGalleryFormBtn">Новая локация</button>
      <button class="theme-toggle" id="themeToggle" title="Сменить тему">
        <i class="fas fa-moon"></i>
      </button>
      <button class="nav-btn" id="loginBtn">Войти</button>
    </div>
  </header>
  <div class="login-modal" id="loginModal">
    <div class="login-modal-content">
      <h2>Вход</h2>
      <div class="login-form-group">
        <label for="username">Имя пользователя</label>
        <input type="text" id="username" placeholder="Введите ваше имя" required>
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" id="cancelLoginBtn">Отмена</button>
        <button class="btn btn-primary" id="submitLoginBtn">Войти</button>
      </div>
    </div>
  </div>
  <div class="book-cover-section" id="bookCoverSection">
    <div class="book-cover-wrapper">
      <img id="bookCoverImage" src="https://via.placeholder.com/400x600/D4A017/2B2B2B?text=Тени+На+Невском" alt="Обложка книги">
    </div>
    <p>Раскройте тайны Санкт-Петербурга 1799 года, где тени скрывают правду!</p>
    <button class="explore-btn" id="exploreChaptersBtnSecondary">
      <i class="fas fa-book-open"></i> Читать главы
    </button>
    <button class="explore-btn" id="exploreGalleryBtnSecondary">
      <i class="fas fa-image"></i> Исследовать локации
    </button>
  </div>
  <div class="container" id="gallerySection">
    <div class="gallery-section">
      <div class="action-bar">
        <div class="status-indicator">
          <span class="status-dot offline" id="galleryStatusDot"></span>
          <span id="galleryStatusText">Оффлайн</span>
        </div>
      </div>
      <div class="gallery-form" id="galleryForm">
        <div class="form-header">
          <h2 id="galleryFormTitle">Новая локация</h2>
        </div>
        <div class="form-group">
          <label for="locationTitle">Название локации</label>
          <input type="text" id="locationTitle" required>
        </div>
        <div class="form-group">
          <label for="locationImage">Ссылка на изображение локации (URL)</label>
          <input type="url" id="locationImage" required>
        </div>
        <div class="form-group">
          <label for="">Персонажи (имя и ссылка на изображение)</label>
          <div class id="characterInputs">
            <div class="character-input-group">
              <div <input type="text" class="character-name" placeholder="Имя персонажа" required>
              <input type="url" class="character-image" placeholder="Ссылка на изображение" required>
              <button class="remove-character-btn" title="Удалить персонажа">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <button class="add-character-btn" id="addCharacterBtn">
            <i class="fas fa-plus"></i> Добавить персонажа
          </button>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" id="cancelGalleryBtn">Отмена</button>
          <button class="btn btn-primary" id="saveGalleryBtn">Сохранить</button>
        </div>
      </div>
      </div>
      <div class="gallery-grid" id="galleryGrid"></div>
      <div class="empty-state" id="galleryEmptyState">
        <i class="fas fa-image"></i>
        <h3>Галерея пуста</h3>
        <p>Добавьте локации и персонажей, чтобы оживить мир Санкт-Петербург!</p>
      </div>
    </div>
  </div>
  <div class="container" id="chaptersSection">
    <div class="action-bar">
      <div class="status-indicator">
        <span class="status-dot offline" id="chapterStatusDot"></span>
        <span id="chapterStatusText">Оффлайн</span>
      </div>
      <button class="language-toggle-btn" id="toggleLanguageBtn">
        <i class="fas fa-globe"></i> <span id="languageText">English</span>
      </button>
    </div>
    <div class="chapter-form" id="chapterForm">
      <div class="form-header">
        <h2 id="chapterFormTitle">Новая глава</h2>
      </div>
      <div class="form-group">
        <label for="chapterTitle">Заголовок (Русский)</label>
        <input type="text" id="chapterTitle" required>
      </div>
      <div class="form-group">
        <label for="chapterTitleEn">Заголовок (Английский)</label>
        <input type="text" id="chapterTitleEn">
      </div>
      <div class="form-group">
        <label for="chapterContent">Содержание (Русский)</label>
        <textarea id="chapterContent" required></textarea>
      </div>
      <div class="form-group">
        <label for="chapterContentEn">Содержание (Английский)</label>
        <textarea id="chapterContentEn"></textarea>
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" id="cancelChapterBtn">Отмена</button>
        <button class="btn btn-primary" id="saveChapterBtn">Сохранить</button>
      </div>
    </div>
    <div class="chapter-grid" id="chapterGrid"></div>
    <div class="empty-state" id="chapterEmptyState">
      <i class="fas fa-book"></i>
      <h3>Главы отсутствуют</h3>
      <p>Создайте новую главу, чтобы начать приключение!</p>
    </div>
  </div>
  <div class="modal" id="chapterModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle"></h2>
        <button class="close-btn" id="closeModalBtn">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <p id="modalContent"></p>
      </div>
    </div>
  </div>
  <div class="modal" id="galleryModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="galleryModalTitle"></h2>
        <button class="modal-close-btn" id="closeGalleryModalBtn">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <img id="galleryModalImage" src="" alt="Изображение локации">
      </div>
    </div>
  </div>
  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyDPDG2j29r3Ay0xS0Y2g1NLYGlbkJNY0yUJI",
    authDomain: "misha-and-anna-48e4c.firebaseapp.com",
    databaseURL: "https://misha-and-anna-48e4c-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "misha-and-anna-48e4c",
    storageBucket: "misha-and-anna-48e4c.appspot.com",
    messagingSenderId: "985103413793",
    appId: "1:985098541390:web:c0b6d10b5e97f0d0ae0"
  };

  try {
    firebase.initializeApp(firebaseConfig);
  } catch (error) {
    console.error('Firebase initialization error:', error);
    alert('Ошибка инициализации Firebase. Проверьте конфигурацию.');
  }
  const database = firebase.database();

  const toggleChapterFormBtn = document.getElementById('toggleChapterFormBtn');
  const chapterForm = document.getElementById('chapterForm');
  const chapterTitle = document.getElementById('chapterTitle');
  const chapterTitleEn = document.getElementById('chapterTitleEn');
  const chapterContent = document.getElementById('chapterContent');
  const chapterContentEn = document.getElementById('chapterContentEn');
  const saveChapterBtn = document.getElementById('saveChapterBtn');
  const cancelChapterBtn = document.getElementById('cancelChapterBtn');
  const chapterFormTitle = document.getElementById('chapterFormTitle');
  const chapterGrid = document.getElementById('chapterGrid');
  const chapterEmptyState = document.getElementById('chapterEmptyState');
  const chapterModal = document.getElementById('chapterModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalContent = document.getElementById('modalContent');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const chapterStatusDot = document.getElementById('chapterStatusDot');
  const chapterStatusText = document.getElementById('chapterStatusText');
  const toggleGalleryFormBtn = document.getElementById('toggleGalleryFormBtn');
  const galleryForm = document.getElementById('galleryForm');
  const locationTitle = document.getElementById('locationTitle');
  const locationImage = document.getElementById('locationImage');
  const characterInputs = document.getElementById('characterInputs');
  const addCharacterBtn = document.getElementById('addCharacterBtn');
  const saveGalleryBtn = document.getElementById('saveGalleryBtn');
  const cancelGalleryBtn = document.getElementById('cancelGalleryBtn');
  const galleryFormTitle = document.getElementById('galleryFormTitle');
  const galleryGrid = document.getElementById('galleryGrid');
  const galleryEmptyState = document.getElementById('galleryEmptyState');
  const galleryStatusDot = document.getElementById('galleryStatusDot');
  const galleryStatusText = document.getElementById('galleryStatusText');
  const loader = document.getElementById('loader');
  const bookCoverImage = document.getElementById('bookCoverImage');
  const exploreChaptersBtn = document.getElementById('exploreChaptersBtn');
  const exploreChaptersBtnSecondary = document.getElementById('exploreChaptersBtnSecondary');
  const exploreGalleryBtn = document.getElementById('exploreGalleryBtn');
  const exploreGalleryBtnSecondary = document.getElementById('exploreGalleryBtnSecondary');
  const chaptersSection = document.getElementById('chaptersSection');
  const gallerySection = document.getElementById('gallerySection');
  const bookCoverSection = document.getElementById('bookCoverSection');
  const themeToggle = document.getElementById('themeToggle');
  const galleryModal = document.getElementById('galleryModal');
  const galleryModalTitle = document.getElementById('galleryModalTitle');
  const galleryModalImage = document.getElementById('galleryModalImage');
  const closeGalleryModalBtn = document.getElementById('closeGalleryModalBtn');
  const loginModal = document.getElementById('loginModal');
  const usernameInput = document.getElementById('username');
  const submitLoginBtn = document.getElementById('submitLoginBtn');
  const cancelLoginBtn = document.getElementById('cancelLoginBtn');
  const loginBtn = document.getElementById('loginBtn');
  const toggleLanguageBtn = document.getElementById('toggleLanguageBtn');
  const languageText = document.getElementById('languageText');

  let isEditingChapter = false;
  let editingChapterId = null;
  let isEditingLocation = false;
  let editingLocationId = null;
  let isAdmin = false;
  let currentLanguage = 'ru';

  function showLoader() {
    loader.style.display = 'flex';
  }

  function hideLoader() {
    loader.style.display = 'none';
  }

  function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast ${type} show`;
    toast.innerHTML = `
      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} toast-icon"></i>
      <span class="toast-message">${message}</span>
    `;
    document.body.appendChild(toast);
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 500);
    }, 4000);
  }

  function updateChapterStatus(status, message) {
    chapterStatusDot.className = `status-dot ${status}`;
    chapterStatusText.textContent = message;
  }

  function updateGalleryStatus(status, message) {
    galleryStatusDot.className = `status-dot ${status}`;
    galleryStatusText.textContent = message;
  }

  function sanitizeHTML(str) {
    if (typeof DOMPurify === 'undefined') {
      console.error('DOMPurify is not loaded');
      return str;
    }
    return DOMPurify.sanitize(str);
  }

  function toggleTheme() {
    const isLightTheme = document.body.classList.toggle('light-theme');
    themeToggle.innerHTML = `<i class="fas fa-${isLightTheme ? 'moon' : 'sun'}"></i>`;
    localStorage.setItem('theme', isLightTheme ? 'light' : 'dark');
    showToast(`Тема изменена на ${isLightTheme ? 'светлую' : 'темную'}`, 'success');
  }

  function loadTheme() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
      document.body.classList.add('light-theme');
      themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
    } else {
      document.body.classList.remove('light-theme');
      themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    }
  }

  function showLoginModal() {
    loginModal.style.display = 'flex';
    usernameInput.focus();
  }

  function hideLoginModal() {
    loginModal.style.display = 'none';
    usernameInput.value = '';
  }

  function updateButtonVisibility() {
    document.querySelectorAll('.admin-only, .edit-btn, .delete-btn').forEach(btn => {
      btn.classList.toggle('hidden-btn', !isAdmin);
    });
    loginBtn.textContent = localStorage.getItem('username') ? 'Выйти' : 'Войти';
  }

  function toggleLanguage() {
    currentLanguage = currentLanguage === 'en' ? 'ru' : 'en';
    languageText.textContent = currentLanguage === 'ru' ? 'English' : 'Русский';
    loadChapters();
    showToast(`Язык изменён на ${currentLanguage === 'ru' ? 'русский' : 'английский'}`, 'success');
  }

  async function loadChapters() {
    try {
      showLoader();
      const snapshot = await database.ref(`precursor_chapters${currentLanguage === 'en' ? '_en' : ''}`).once('value');
      const chapters = snapshot.val();
      chapterGrid.innerHTML = '';
      if (chapters) {
        Object.entries(chapters).forEach(([id, chapter]) => {
          const card = document.createElement('div');
          card.className = 'chapter-card';
          card.innerHTML = `
            <div class="card-content">
              <h3>${sanitizeHTML(chapter.title)}</h3>
              <p>${sanitizeHTML(chapter.content.substring(0, 100))}...</p>
            </div>
            <div class="card-footer">
              <button class="card-btn view-btn" data-id="${id}">
                <i class="fas fa-eye"></i>
              </button>
              <button class="card-btn copy-btn" data-id="${id}" title="Копировать текст главы">
                <i class="fas fa-copy"></i>
              </button>
              ${isAdmin ? `
                <button class="card-btn edit-btn" data-id="${id}">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="card-btn delete-btn" data-id="${id}">
                  <i class="fas fa-trash"></i>
                </button>
              ` : ''}
            </div>
          `;
          chapterGrid.appendChild(card);
        });
        chapterEmptyState.style.display = 'none';
      } else {
        chapterEmptyState.style.display = 'block';
      }
      updateChapterStatus('online', 'Главы загружены');
    } catch (error) {
      console.error('Error loading chapters:', error);
      updateChapterStatus('offline', 'Ошибка загрузки');
      showToast('Ошибка загрузки глав', 'error');
    } finally {
      hideLoader();
    }
  }

  async function loadGallery() {
    try {
      showLoader();
      const snapshot = await database.ref('gallery_locations').once('value');
      const locations = snapshot.val();
      galleryGrid.innerHTML = '';
      if (locations) {
        Object.entries(locations).forEach(([id, location]) => {
          const card = document.createElement('div');
          card.className = 'location-card';
          card.innerHTML = `
            <img src="${sanitizeHTML(location.image)}" alt="${sanitizeHTML(location.title)}">
            <h3 class="location-title">${sanitizeHTML(location.title)}</h3>
            <div class="card-footer">
              ${isAdmin ? `
                <button class="card-btn edit-btn" data-id="${id}">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="card-btn delete-btn" data-id="${id}">
                  <i class="fas fa-trash"></i>
                </button>
              ` : ''}
            </div>
            <div class="character-grid" id="characterGrid-${id}">
              ${location.characters ? Object.entries(location.characters).map(([charId, char]) => `
                <div class="character-card">
                  <img src="${sanitizeHTML(char.image)}" alt="${sanitizeHTML(char.name)}">
                  <div class="character-name">${sanitizeHTML(char.name)}</div>
                </div>
              `).join('') : ''}
            </div>
          `;
          galleryGrid.appendChild(card);
          const characterGrid = document.getElementById(`characterGrid-${id}`);
          card.querySelector('img').addEventListener('click', () => {
            galleryModalTitle.textContent = location.title;
            galleryModalImage.src = location.image;
            galleryModalImage.alt = location.title;
            galleryModal.style.display = 'flex';
          });
          card.querySelector('h3.location-title').addEventListener('click', () => {
            characterGrid.classList.toggle('active');
          });
        });
        galleryEmptyState.style.display = 'none';
      } else {
        galleryEmptyState.style.display = 'block';
      }
      updateGalleryStatus('online', 'Галерея загружена');
    } catch (error) {
      console.error('Error loading gallery:', error);
      updateGalleryStatus('offline', 'Ошибка загрузки');
      showToast('Ошибка загрузки галереи', 'error');
    } finally {
      hideLoader();
    }
  }

  async function loadBookCover() {
    try {
      const snapshot = await database.ref('book_cover').once('value');
      const cover = snapshot.val();
      if (cover && cover.url) {
        bookCoverImage.src = sanitizeHTML(cover.url);
      }
    } catch (error) {
      console.error('Error loading book cover:', error);
      showToast('Ошибка загрузки обложки', 'error');
    }
  }

  function showChapters() {
    bookCoverSection.classList.remove('visible');
    chaptersSection.classList.add('visible');
    gallerySection.classList.remove('visible');
    chaptersSection.scrollIntoView({ behavior: 'smooth' });
  }

  function showGallery() {
    bookCoverSection.classList.remove('visible');
    gallerySection.classList.add('visible');
    chaptersSection.classList.remove('visible');
    gallerySection.scrollIntoView({ behavior: 'smooth' });
  }

  toggleChapterFormBtn.addEventListener('click', () => {
    if (!isAdmin) {
      showToast('Только администратор может добавлять главы', 'error');
      return;
    }
    isEditingChapter = false;
    chapterForm.style.display = 'block';
    chapterFormTitle.textContent = 'Новая глава';
    chapterTitle.value = '';
    chapterContent.value = '';
    chapterTitleEn.value = '';
    chapterContentEn.value = '';
    chapterTitle.focus();
    chaptersSection.scrollIntoView({ behavior: 'smooth' });
  });

  cancelChapterBtn.addEventListener('click', () => {
    chapterForm.style.display = 'none';
    chapterTitle.value = '';
    chapterContent.value = '';
    chapterTitleEn.value = '';
    chapterContentEn.value = '';
    isEditingChapter = false;
    editingChapterId = null;
  });

  saveChapterBtn.addEventListener('click', async () => {
    if (!isAdmin) {
      showToast('Только администратор может сохранять главы', 'error');
      return;
    }
    const title = chapterTitle.value.trim();
    const content = chapterContent.value.trim();
    const titleEn = chapterTitleEn.value.trim();
    const contentEn = chapterContentEn.value.trim();
    if (!title || !content) {
      showToast('Заполните обязательные поля на русском!', 'error');
      return;
    }
    try {
      showLoader();
      const chapterData = { title, content };
      const chapterDataEn = titleEn && contentEn ? { title: titleEn, content: contentEn } : null;
      if (isEditingChapter) {
        await database.ref(`precursor_chapters/${editingChapterId}`).update(chapterData);
        if (chapterDataEn) {
          await database.ref(`precursor_chapters_en/${editingChapterId}`).update(chapterDataEn);
        } else {
          await database.ref(`precursor_chapters_en/${editingChapterId}`).remove();
        }
        showToast('Глава успешно обновлена', 'success');
      } else {
        const newChapterRef = await database.ref('precursor_chapters').push(chapterData);
        if (chapterDataEn) {
          await database.ref(`precursor_chapters_en/${newChapterRef.key}`).set(chapterDataEn);
        }
        showToast('Глава успешно добавлена', 'success');
      }
      chapterForm.style.display = 'none';
      chapterTitle.value = '';
      chapterContent.value = '';
      chapterTitleEn.value = '';
      chapterContentEn.value = '';
      isEditingChapter = false;
      editingChapterId = null;
      loadChapters();
    } catch (error) {
      console.error('Error saving chapter:', error);
      showToast('Ошибка сохранения главы', 'error');
    } finally {
      hideLoader();
    }
  });

  toggleGalleryFormBtn.addEventListener('click', () => {
    if (!isAdmin) {
      showToast('Только администратор может добавлять локации!', 'error');
      return;
    }
    isEditingLocation = false;
    galleryForm.style.display = 'block';
    galleryFormTitle.textContent = 'Новая локация';
    locationTitle.value = '';
    locationImage.value = '';
    characterInputs.innerHTML = `
      <div class="character-input-group">
        <input type="text" class="character-name" placeholder="Имя персонажа" required>
        <input type="url" class="character-image" placeholder="Ссылка на изображение" required>
        <button class="remove-character-btn" title="Удалить персонажа">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    `;
    locationTitle.focus();
    gallerySection.scrollIntoView({ behavior: 'smooth' });
  });

  cancelGalleryBtn.addEventListener('click', () => {
    galleryForm.style.display = 'none';
    locationTitle.value = '';
    locationImage.value = '';
    characterInputs.innerHTML = `
      <div class="character-input-group">
        <input type="text" class="character-name" placeholder="Имя персонажа" required>
        <input type="url" class="character-image" placeholder="Ссылка на изображение" required>
        <button class="remove-character-btn" title="Удалить персонажа">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    `;
    isEditingLocation = false;
    editingLocationId = null;
  });

  addCharacterBtn.addEventListener('click', () => {
    const characterInputGroup = document.createElement('div');
    characterInputGroup.className = 'character-input-group';
    characterInputGroup.innerHTML = `
      <input type="text" class="character-name" placeholder="Имя персонажа" required>
      <input type="url" class="character-image" placeholder="Ссылка на изображение" required>
      <button class="remove-character-btn" title="Удалить персонажа">
        <i class="fas fa-trash"></i>
      </button>
    `;
    characterInputs.appendChild(characterInputGroup);
  });

  characterInputs.addEventListener('click', (e) => {
    if (e.target.closest('.remove-character-btn') && characterInputs.children.length > 1) {
      e.target.closest('.character-input-group').remove();
    }
  });

  saveGalleryBtn.addEventListener('click', async () => {
    if (!isAdmin) {
      showToast('Только администратор может сохранять локации!', 'error');
      return;
    }
    const title = locationTitle.value.trim();
    const image = locationImage.value.trim();
    const characters = {};
    let isValid = true;
    document.querySelectorAll('.character-input-group').forEach((group, index) => {
      const nameInput = group.querySelector('.character-name').value.trim();
      const charImage = group.querySelector('.character-image').value.trim();
      if (nameInput && charImage) {
        characters[`char${index}`] = { name: nameInput, image: charImage };
      } else if (nameInput || charImage) {
        isValid = false;
      }
    });
    if (!title || !image || !isValid) {
      showToast('Ошибка ввода данных. Проверьте поля!', 'error');
      return;
    }
    try {
      showLoader();
      const locationData = { title, image, characters };
      if (isEditingLocation) {
        await database.ref(`gallery_locations/${editingLocationId}`).update(locationData);
        showToast('Локация успешно обновлена!', 'success');
      } else {
        await database.ref('gallery_locations').push(locationData);
        showToast('Локация успешно добавлена!', 'success');
      }
      galleryForm.style.display = 'none';
      locationTitle.value = '';
      locationImage.value = '';
      characterInputs.innerHTML = `
        <div class="character-input-group">
          <input type="text" class="character-name" placeholder="Имя персонажа" required>
          <input type="url" class="character-image" placeholder="Ссылка на изображение" required>
          <button class="remove-character-btn" title="Удалить персонажа">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;
      isEditingLocation = false;
      editingLocationId = null;
      loadGallery();
    } catch (error) {
      console.error('Error saving location:', error);
      showToast('Ошибка при сохранении локации', 'error');
    } finally {
      hideLoader();
    }
  });

  chapterGrid.addEventListener('click', async (e) => {
    const viewBtn = e.target.closest('.view-btn');
    const editBtn = e.target.closest('.edit-btn');
    const deleteBtn = e.target.closest('.delete-btn');
    const copyBtn = e.target.closest('.copy-btn');
    if (viewBtn) {
      const id = viewBtn.dataset.id;
      try {
        showLoader();
        const snapshot = await database.ref(`precursor_chapters${currentLanguage === 'en' ? '_en' : ''}/${id}`).once('value');
        const chapter = snapshot.val();
        if (chapter) {
          modalTitle.textContent = chapter.title;
          modalContent.innerHTML = sanitizeHTML(chapter.content.replace(/\n/g, '<br>'));
          chapterModal.style.display = 'flex';
        }
      } catch (error) {
        console.error('Error viewing chapter:', error);
        showToast('Ошибка при загрузке главы', 'error');
      } finally {
        hideLoader();
      }
    } else if (editBtn && isAdmin) {
      const id = editBtn.dataset.id;
      try {
        showLoader();
        const snapshot = await database.ref(`precursor_chapters/${id}`).once('value');
        const snapshotEn = await database.ref(`precursor_chapters_en/${id}`).once('value');
        const chapter = snapshot.val();
        const chapterEn = snapshotEn.val() || {};
        if (chapter) {
          isEditingChapter = true;
          editingChapterId = id;
          chapterForm.style.display = 'block';
          chapterFormTitle.textContent = 'Редактировать главу';
          chapterTitle.value = chapter.title;
          chapterContent.value = chapter.content;
          chapterTitleEn.value = chapterEn.title || '';
          chapterContentEn.value = chapterEn.content || '';
          chaptersSection.scrollIntoView({ behavior: 'smooth' });
        }
      } catch (error) {
        console.error('Error editing chapter:', error);
        showToast('Ошибка при загрузке главы для редактирования', 'error');
      } finally {
        hideLoader();
      }
    } else if (deleteBtn && isAdmin) {
      const id = deleteBtn.dataset.id;
      if (confirm('Вы уверены, что хотите удалить эту главу?')) {
        try {
          showLoader();
          await database.ref(`precursor_chapters/${id}`).remove();
          await database.ref(`precursor_chapters_en/${id}`).remove();
          showToast('Глава удалена', 'success');
          loadChapters();
        } catch (error) {
          console.error('Error deleting chapter:', error);
          showToast('Ошибка при удалении главы', 'error');
        } finally {
          hideLoader();
        }
      }
    } else if (copyBtn) {
      const id = copyBtn.dataset.id;
      try {
        showLoader();
        const snapshot = await database.ref(`precursor_chapters${currentLanguage === 'en' ? '_en' : ''}/${id}`).once('value');
        const chapter = snapshot.val();
        if (chapter) {
          await navigator.clipboard.write(chapter.content);
          showToast('Текст главы скопирован в буфер обмена', 'success');
        }
      } catch (error) {
        console.error('Error copying chapter:', error);
        showToast('Ошибка при копировании текста главы', 'error');
      } finally {
        hideLoader();
      }
    }
  });

  galleryGrid.addEventListener('click', async (e) => {
    const editBtn = e.target.closest('.edit-btn');
    const deleteBtn = e.target.closest('.delete-btn');
    if (editBtn && isAdmin) {
      const id = editBtn.dataset.id;
      try {
        showLoader();
        const snapshot = await database.ref(`gallery_locations/${id}`).once('value');
        const location = snapshot.val();
        if (location) {
          isEditingLocation = true;
          editingLocationId = id;
          galleryForm.style.display = 'block';
          galleryFormTitle.textContent = 'Редактировать локацию';
          locationTitle.value = location.title;
          locationImage.value = location.image;
          characterInputs.innerHTML = '';
          if (location.characters) {
            Object.values(location.characters).forEach(char => {
              const characterInputGroup = document.createElement('div');
              characterInputGroup.className = 'character-input-group';
              characterInputGroup.innerHTML = `
                <input type="text" class="character-name" value="${sanitizeHTML(char.name)}" placeholder="Имя персонажа" required>
                <input type="url" class="character-image" value="${sanitizeHTML(char.image)}" placeholder="Ссылка на изображение" required>
                <button class="remove-character-btn" title="Удалить персонажа">
                  <i class="fas fa-trash"></i>
                </button>
              `;
              characterInputs.appendChild(characterInputGroup);
            });
          } else {
            characterInputs.innerHTML = `
              <div class="character-input-group">
                <input type="text" class="character-name" placeholder="Имя персонажа" required>
                <input type="url" class="character-image" placeholder="Ссылка на изображение" required>
                <button class="remove-character-btn" title="Удалить персонажа">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            `;
          }
          gallerySection.scrollIntoView({ behavior: 'smooth' });
        }
      } catch (error) {
        console.error('Error editing location:', error);
        showToast('Ошибка при загрузке локации для редактирования', 'error');
      } finally {
        hideLoader();
      }
    } else if (deleteBtn && isAdmin) {
      const id = deleteBtn.dataset.id;
      if (confirm('Вы уверены, что хотите удалить эту локацию?')) {
        try {
          showLoader();
          await database.ref(`gallery_locations/${id}`).remove();
          showToast('Локация удалена', 'success');
          loadGallery();
        } catch (error) {
          console.error('Error deleting location:', error);
          showToast('Ошибка при удалении локации', 'error');
        } finally {
          hideLoader();
        }
      }
    }
  });

  closeModalBtn.addEventListener('click', () => {
    chapterModal.style.display = 'none';
  });

  closeGalleryModalBtn.addEventListener('click', () => {
    galleryModal.style.display = 'none';
  });

  exploreChaptersBtn.addEventListener('click', showChapters);
  exploreChaptersBtnSecondary.addEventListener('click', showChapters);
  exploreGalleryBtn.addEventListener('click', showGallery);
  exploreGalleryBtnSecondary.addEventListener('click', showGallery);
  themeToggle.addEventListener('click', toggleTheme);

  submitLoginBtn.addEventListener('click', () => {
    const username = usernameInput.value.trim();
    if (!username) {
      showToast('Введите имя пользователя', 'error');
      return;
    }
    isAdmin = username === 'Михаил Калепназ';
    localStorage.setItem('username', username);
    localStorage.setItem('isAdmin', isAdmin);
    hideLoginModal();
    updateButtonVisibility();
    showToast(`Добро пожаловать, ${username}!`, 'success');
  });

  cancelLoginBtn.addEventListener('click', () => {
    hideLoginModal();
  });

  loginBtn.addEventListener('click', () => {
    if (localStorage.getItem('username')) {
      localStorage.removeItem('username');
      localStorage.removeItem('isAdmin');
      isAdmin = false;
      updateButtonVisibility();
      showToast('Вы вышли из системы', 'success');
    }
    showLoginModal();
  });

  toggleLanguageBtn.addEventListener('click', toggleLanguage);

  document.addEventListener('DOMContentLoaded', async () => {
    try {
      updateChapterStatus('syncing', 'Соединение с базой данных');
      updateGalleryStatus('syncing', 'Соединение с базой данных');
      loadTheme();
      const savedUsername = localStorage.getItem('username');
      if (savedUsername) {
        isAdmin = localStorage.getItem('isAdmin') === 'true';
        updateButtonVisibility();
      } else {
        showLoginModal();
      }
      await loadBookCover();
      await loadChapters();
      await loadGallery();
      bookCoverSection.classList.add('visible');
    } catch (error) {
      console.error('Initialization error:', error);
      showToast('Ошибка при инициализации приложения', 'error');
    }
  });
</script>
</body>
</html>
